<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>æœªæ¥å›éŸ³ ğŸ’Œ</title>
<style>
body {
  margin: 0;
  padding: 0;
  font-family: 'PingFang SC', 'Segoe UI', sans-serif;
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
  background: linear-gradient(135deg,#f0f4ff,#fff9f2);
  position: relative;
  user-select: none;
}

/* èƒŒæ™¯å®¹å™¨ */
#bgContainer {
  position: absolute; top:0; left:0;
  width:100%; height:100%;
  background-size: cover;
  background-position: center;
  z-index:-1;
  transition: background 0.5s ease;
}
#changeBgHint {
  position: absolute;
  bottom: 20px; left:50%;
  transform: translateX(-50%);
  font-size: 0.9rem;
  color: #666;
  opacity: 0;
  transition: opacity 0.3s;
  pointer-events: none;
}

/* ä¿¡å° */
.envelope-container {
  perspective: 1000px;
  display: flex;
  justify-content: center;
  align-items: center;
  position: absolute;
  width: 50%; height: 50%;
}
.envelope {
  width: 100%; height: 100%;
  max-width: 600px; max-height: 600px;
  background: rgba(255,255,255,0.85);
  border-radius: 24px;
  border: 2px solid rgba(255,255,255,0.6);
  box-shadow: 0 12px 36px rgba(0,0,0,0.2);
  display:flex; justify-content:center; align-items:center;
  font-size:4rem; color:#5a7cff;
  cursor:pointer;
  animation: sway 2s ease-in-out infinite alternate;
  transition: opacity 1s ease;
}
.envelope.open { animation-play-state:paused; opacity:0; }
@keyframes sway {0%{transform:rotateY(-5deg);}100%{transform:rotateY(5deg);}}

/* è¾“å…¥é¢æ¿ */
#inputPanel {
  display: none;
  flex-direction: column;
  align-items: center;
  width: 50%; max-width: 600px;
  position: relative;
}
#inputPanel::before {
  content:'';
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background: rgba(255,255,255,0.2);
  border-radius: 24px;
  backdrop-filter: blur(10px);
  z-index:-1;
}
h1 {
  font-size: 2rem;
  background: linear-gradient(90deg,#5a7cff,#a0c4ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 1rem;
}
#userInput {
  width:100%;
  padding:1rem;
  border-radius: 16px;
  border:1px solid rgba(0,0,0,0.1);
  font-size:1rem;
  backdrop-filter: blur(8px);
  background: rgba(255,255,255,0.6);
  margin-bottom:0.6rem;
  resize:none;
}
button {
  border:none;
  border-radius: 16px;
  padding:0.8rem 1rem;
  font-size:1rem;
  cursor:pointer;
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.6);
  color:#333;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
button:hover { background: rgba(255,255,255,0.85); }
#sendBtn { width:100%; margin-bottom:0.5rem; }

#loading { margin-top:0.5rem; color:#666; display:none; }

/* ä¿¡çº¸é¢æ¿ */
#letterPanel {
  display:none;
  flex-direction: column;
  align-items: center;
  background: rgba(255,255,255,0.95);
  background-image: linear-gradient(to bottom, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%), url('https://www.transparenttextures.com/patterns/paper-fibers.png');
  background-repeat: repeat;
  backdrop-filter: blur(10px);
  border-radius:24px;
  box-shadow:0 12px 36px rgba(0,0,0,0.2);
  padding:1rem;
  width:50%; max-width:600px; max-height:50%;
  overflow-y:auto;
  transform: scaleY(0); transform-origin: top;
  transition: transform 1s ease, opacity 0.8s ease;
}
#letterPanel.show { transform: scaleY(1); }

#letterText {
  width:100%;
  white-space: pre-wrap;
  font-size:1rem;
  color:#333;
  flex:1;
  margin-bottom:0.6rem;
}

.letterControls { display:flex; justify-content:space-between; width:100%; gap:1rem; }
.letterControls button { flex:1; }

/* èƒŒæ™¯åŠ å· */
#bgPlus { display:none; font-size:3rem; color:#5a7cff; cursor:pointer; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }

/* èƒŒæ™¯ç®¡ç†é¢æ¿ */
#bgManager {
  display:none;
  position:absolute; top:10%; left:50%;
  transform: translateX(-50%);
  width:60%; max-width:600px;
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(12px);
  border-radius: 20px;
  box-shadow:0 12px 36px rgba(0,0,0,0.2);
  padding: 1rem;
  flex-direction: column;
  z-index:1000;
}
#bgHistory { display:flex; gap:0.5rem; overflow-x:auto; margin-top:0.5rem; }
.bgHistoryItem {
  width:50px; height:50px;
  border-radius:12px;
  border:1px solid #ccc;
  cursor:pointer;
  flex-shrink:0;
  background-size:cover;
  background-position:center;
}
#bgManager button { margin-top:0.5rem; }

</style>
</head>
<body>

<div id="bgContainer"></div>
<div id="changeBgHint">æ›´æ”¹èƒŒæ™¯</div>

<div class="envelope-container">
  <div class="envelope" id="envelope"></div>
</div>

<div id="inputPanel">
  <h1>æœªæ¥å›éŸ³</h1>
  <textarea id="userInput" placeholder="å†™ä¸‹æ­¤åˆ»çš„å¿ƒå£°ã€ç–‘æƒ‘æˆ–æ„¿æœ›..."></textarea>
  <button id="sendBtn">ç”Ÿæˆæœªæ¥å›ä¿¡</button>
  <div id="loading">æ­£åœ¨ç”Ÿæˆæœªæ¥çš„å›éŸ³...</div>
</div>

<div id="letterPanel">
  <div id="letterText"></div>
  <div class="letterControls">
    <button id="closeLetter">æ”¶èµ·å›ä¿¡</button>
    <button id="playVoice">è¯­éŸ³æ’­æ”¾</button>
  </div>
</div>

<div id="bgPlus">+</div>

<div id="bgManager">
  <label>å¯¼å…¥èƒŒæ™¯å›¾ç‰‡ï¼š</label>
  <input type="file" id="bgFileInput" accept="image/*">
  <div id="bgHistory"></div>
  <button id="bgCloseBtn">é€€å‡ºæ›´æ”¹èƒŒæ™¯</button>
</div>

<script>
(function(){
const envelope = document.getElementById('envelope');
const inputPanel = document.getElementById('inputPanel');
const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');
const loadingEl = document.getElementById('loading');
const letterPanel = document.getElementById('letterPanel');
const letterText = document.getElementById('letterText');
const closeLetter = document.getElementById('closeLetter');
const playVoice = document.getElementById('playVoice');
const bgContainer = document.getElementById('bgContainer');
const bgPlus = document.getElementById('bgPlus');
const changeBgHint = document.getElementById('changeBgHint');
const bgManager = document.getElementById('bgManager');
const bgFileInput = document.getElementById('bgFileInput');
const bgCloseBtn = document.getElementById('bgCloseBtn');
const bgHistoryEl = document.getElementById('bgHistory');

let bgHistory = [];
let isPlaying = false;
let utter;

// åˆå§‹ä¿¡å°åŠ¨ç”»
envelope.addEventListener('click', ()=>{
  envelope.classList.add('open');
  setTimeout(()=>{ envelope.parentElement.style.display='none'; inputPanel.style.display='flex'; },1000);
});

// ç”Ÿæˆå›ä¿¡
sendBtn.addEventListener('click', async ()=>{
  const input = userInput.value.trim();
  if(!input) return alert('è¯·è¾“å…¥å†…å®¹');
  loadingEl.style.display='block';
  letterText.innerText='';
  try{
    const res = await fetch('/api/generate',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({input}) });
    const data = await res.json();
    letterText.innerText = data.reply||'æœªæ¥æš‚æ—¶æ²¡æ¥å¾—åŠå›å¤ã€‚';
    loadingEl.style.display='none';
    inputPanel.style.display='none';
    letterPanel.style.display='flex';
    setTimeout(()=>{ letterPanel.classList.add('show'); },50);
  }catch(err){
    loadingEl.style.display='none';
    letterText.innerText='ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯:'+err.message;
    inputPanel.style.display='none';
    letterPanel.style.display='flex';
    setTimeout(()=>{ letterPanel.classList.add('show'); },50);
  }
});

// æ”¶èµ·ä¿¡çº¸
closeLetter.addEventListener('click', hideLetter);

function hideLetter(){
  letterPanel.classList.remove('show');
  stopVoice();
  setTimeout(()=>{
    letterPanel.style.display='none';
    bgPlus.style.display='block';
    changeBgHint.style.opacity=1;
  },800);
}

// è¯­éŸ³æ’­æ”¾
playVoice.addEventListener('click', ()=>{
  if(!isPlaying){
    const text = letterText.innerText.trim();
    if(!text) return;
    utter = new SpeechSynthesisUtterance(text);
    utter.lang='zh-CN';
    utter.onend=()=>{ resetVoiceBtn(); };
    speechSynthesis.speak(utter);
    isPlaying=true;
    playVoice.innerText='åœæ­¢æ’­æ”¾';
  }else stopVoice();
});

function stopVoice(){
  if(isPlaying) speechSynthesis.cancel();
  isPlaying=false;
  resetVoiceBtn();
}

function resetVoiceBtn(){ playVoice.innerText='è¯­éŸ³æ’­æ”¾'; }

// èƒŒæ™¯æ›´æ”¹é¢æ¿æ˜¾ç¤ºæ–¹å¼
function showBgManager(e){
  e.preventDefault();
  bgManager.style.display='flex';
}
function hideBgManager(){ bgManager.style.display='none'; }

bgCloseBtn.addEventListener('click', hideBgManager);

// PCå³é”® / ç§»åŠ¨é•¿æŒ‰è§¦å‘
bgContainer.addEventListener('contextmenu', showBgManager);
let longPressTimer = null;
bgContainer.addEventListener('touchstart', ()=>{
  longPressTimer = setTimeout(showBgManager,600);
});
bgContainer.addEventListener('touchend', ()=>{ clearTimeout(longPressTimer); });

// å¯¼å…¥èƒŒæ™¯å›¾ç‰‡
bgFileInput.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload=function(evt){
    const url = evt.target.result;
    bgContainer.style.background=`url(${url}) center/cover no-repeat`;
    bgHistory.push(url);
    updateBgHistory();
  };
  reader.readAsDataURL(file);
});

// èƒŒæ™¯å†å²
function updateBgHistory(){
  bgHistoryEl.innerHTML='';
  bgHistory.slice().reverse().forEach((bg,index)=>{
    const div = document.createElement('div');
    div.className='bgHistoryItem';
    div.style.backgroundImage=`url(${bg})`;
    div.onclick=()=>{ bgContainer.style.background=`url(${bg}) center/cover no-repeat`; };
    bgHistoryEl.appendChild(div);
  });
}

// ç‚¹å‡»èƒŒæ™¯åŠ å·
bgPlus.addEventListener('click', ()=>{ bgManager.style.display='flex'; });

// é¼ æ ‡æç¤º
bgPlus.addEventListener('mouseenter', ()=>{ changeBgHint.style.opacity=1; });
bgPlus.addEventListener('mouseleave', ()=>{ changeBgHint.style.opacity=0; });

// ç‚¹å‡»èƒŒæ™¯æ”¶èµ·ä¿¡çº¸
bgContainer.addEventListener('click', ()=>{
  if(letterPanel.style.display==='flex') hideLetter();
});

})();
</script>
</body>
</html>
