<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>æœªæ¥å›éŸ³ ğŸ’Œ</title>
<style>
body {
  margin:0; padding:0; font-family:'PingFang SC','Segoe UI',sans-serif;
  height:100vh; width:100vw;
  display:flex; justify-content:center; align-items:center;
  overflow:hidden;
  background: linear-gradient(135deg,#f7f5f8,#eef6f9);
  position:relative;
  user-select:none;
}

/* èƒŒæ™¯å®¹å™¨ï¼Œå¯ç‚¹å‡»æ›´æ¢èƒŒæ™¯ */
#bgContainer {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background-size:cover; background-position:center;
  z-index:-1; transition: background 0.5s ease;
}

/* ä¿¡å°åˆå§‹åŠ¨ç”» */
.envelope-container {
  perspective:1000px;
  display:flex; justify-content:center; align-items:center;
  width:50%; height:50%; max-width:600px; max-height:600px;
}
.envelope {
  width:100%; height:100%;
  background:#fff; border:2px solid #f4c7d0; border-radius:16px;
  box-shadow:0 12px 36px rgba(0,0,0,0.1);
  display:flex; justify-content:center; align-items:center;
  font-size:6rem; color:#f7a9c4; cursor:pointer;
  animation:sway 2s ease-in-out infinite alternate;
  transition:all 1s ease;
}
.envelope::before {
  content:""; position:absolute; top:0; left:0; width:100%; height:100%;
  background: linear-gradient(to bottom right, #fce6f1, #eaf5fb);
  clip-path: polygon(0 0, 100% 0, 50% 50%);
}
.envelope.open { animation-play-state:paused; opacity:0; }
@keyframes sway {0%{transform:rotateY(-5deg);}100%{transform:rotateY(5deg);}}

/* è¾“å…¥ç•Œé¢ */
#inputPanel {
  display:none; flex-direction:column; align-items:center;
  width:60%; max-width:700px;
  position:relative; transition: all 0.5s ease;
}
#inputPanel::before {
  content:"";
  position:absolute; top:0; left:0; right:0; bottom:0;
  background: rgba(255,255,255,0.25);
  border-radius:24px;
  backdrop-filter: blur(12px);
  z-index:-1;
}
h1 {
  font-size:3rem; margin-bottom:2rem;
  background: linear-gradient(90deg,#f8c6d0,#b5d9f0);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
#userInput {
  width:100%; padding:1.2rem; border-radius:20px;
  border:1px solid rgba(0,0,0,0.05); font-size:1.2rem;
  backdrop-filter: blur(8px); background: rgba(255,255,255,0.5);
  resize:none; margin-bottom:1rem;
}
#voiceSelect { margin-bottom:0.5rem; width:100%; padding:0.6rem; border-radius:12px; border:1px solid #ccc; }

#sendBtn {
  width:50%; padding:0.8rem;
  border:none; border-radius:16px; cursor:pointer;
  font-size:1.1rem;
  background: linear-gradient(90deg,#f8c6d0,#b5d9f0);
  color:white; box-shadow:0 4px 12px rgba(0,0,0,0.1);
  transition:0.3s;
}
#sendBtn:hover { opacity:0.85; }

#loading { margin-top:0.5rem; color:#666; display:none; }

/* ä¿¡çº¸å›ä¿¡ç•Œé¢ */
#letterPanel {
  display:none; flex-direction:column; align-items:center;
  background: rgba(255,255,255,0.95);
  border-radius:24px;
  box-shadow:0 12px 36px rgba(0,0,0,0.15);
  padding:1rem; width:60%; max-width:700px; max-height:50%;
  overflow-y:auto;
  opacity:0; transition:opacity 0.8s ease;
}
#letterPanel.show { opacity:1; }
#letterText { width:100%; white-space:pre-wrap; font-size:1rem; color:#333; flex:1; margin-bottom:0.6rem; }
.letterControls { display:flex; justify-content:space-between; width:100%; gap:1rem; }
.letterControls button { flex:1; border:none; border-radius:16px; padding:0.6rem; backdrop-filter: blur(10px); background: rgba(255,255,255,0.6); box-shadow:0 4px 12px rgba(0,0,0,0.1); cursor:pointer; transition:0.3s; }
.letterControls button:hover { background: rgba(255,255,255,0.85); }

</style>
</head>
<body>
<div id="bgContainer"></div>

<div class="envelope-container">
  <div class="envelope" id="envelope">âœ‰ï¸</div>
</div>

<div id="inputPanel">
  <h1>æœªæ¥å›éŸ³</h1>
  <textarea id="userInput" placeholder="å†™ä¸‹æ­¤åˆ»çš„å¿ƒå£°ã€ç–‘æƒ‘æˆ–æ„¿æœ›..."></textarea>
  <select id="voiceSelect">
    <option value="male">ç”·å£°</option>
    <option value="female">å¥³å£°</option>
  </select>
  <button id="sendBtn">ç”Ÿæˆæœªæ¥å›ä¿¡</button>
  <div id="loading">æ­£åœ¨ç”Ÿæˆæœªæ¥çš„å›éŸ³...</div>
</div>

<div id="letterPanel">
  <div id="letterText"></div>
  <div class="letterControls">
    <button id="closeLetter">æ”¶èµ·å›ä¿¡</button>
    <button id="playVoice">è¯­éŸ³æ’­æ”¾</button>
  </div>
</div>

<script>
(function(){
const envelope = document.getElementById('envelope');
const inputPanel = document.getElementById('inputPanel');
const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');
const voiceSelect = document.getElementById('voiceSelect');
const loadingEl = document.getElementById('loading');
const letterPanel = document.getElementById('letterPanel');
const letterText = document.getElementById('letterText');
const closeLetter = document.getElementById('closeLetter');
const playVoice = document.getElementById('playVoice');
const bgContainer = document.getElementById('bgContainer');

let isPlaying = false;
let audioObj = null;

// ä¿¡å°ç‚¹å‡»
envelope.addEventListener('click', ()=>{
  envelope.classList.add('open');
  setTimeout(()=>{
    envelope.parentElement.style.display='none';
    inputPanel.style.display='flex';
  },1000);
});

// ç”Ÿæˆå›ä¿¡
sendBtn.addEventListener('click', async ()=>{
  const input = userInput.value.trim();
  if(!input){ alert('è¯·è¾“å…¥å†…å®¹'); return; }
  loadingEl.style.display='block';
  letterText.innerText='';
  try{
    const res = await fetch('/api/generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({input})
    });
    const data = await res.json();
    letterText.innerText = data.reply || 'æœªæ¥æš‚æ—¶æ²¡æ¥å¾—åŠå›å¤ã€‚';
    loadingEl.style.display='none';
    inputPanel.style.display='none';
    letterPanel.style.display='flex';
    setTimeout(()=>{ letterPanel.classList.add('show'); },50);
  }catch(err){
    loadingEl.style.display='none';
    letterText.innerText='ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯:'+err.message;
    inputPanel.style.display='none';
    letterPanel.style.display='flex';
    setTimeout(()=>{ letterPanel.classList.add('show'); },50);
  }
});

// æ”¶èµ·å›ä¿¡
closeLetter.addEventListener('click', ()=>{
  letterPanel.classList.remove('show');
  stopVoice();
  setTimeout(()=>{
    letterPanel.style.display='none';
    inputPanel.style.display='flex';
  },800);
});

// æ’­æ”¾
