<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>æœªæ¥å›éŸ³ ğŸ’Œ</title>
<style>
body {
  margin: 0; padding: 0;
  font-family:'PingFang SC','Segoe UI',sans-serif;
  height:100vh; width:100vw;
  overflow:hidden; display:flex; justify-content:center; align-items:center;
  background: linear-gradient(135deg,#f0f4ff,#fff9f2);
  position:relative; user-select:none;
}

/* èƒŒæ™¯å®¹å™¨ */
#bgContainer {
  position:absolute; top:0; left:0; width:100%; height:100%;
  background-size:cover; background-position:center;
  z-index:-1; transition: background 0.5s ease;
}

/* ä¿¡å°åˆå§‹ç•Œé¢ */
.envelope-container {
  perspective:1000px;
  display:flex; justify-content:center; align-items:center;
  width:50%; height:50%; max-width:600px; max-height:600px;
}
.envelope {
  width:100%; height:100%;
  background:#fff;
  border:2px solid #c7d2fe;
  border-radius:16px;
  box-shadow:0 12px 36px rgba(0,0,0,0.2);
  display:flex; justify-content:center; align-items:center;
  font-size:6rem; color:#5a7cff; cursor:pointer;
  animation: sway 2s ease-in-out infinite alternate;
  position:relative; transition:all 1s ease;
}
.envelope::before {
  content:""; position:absolute; top:0; left:0;
  width:100%; height:100%;
  background: linear-gradient(to bottom right, #e0ebff, #fff);
  clip-path: polygon(0 0, 100% 0, 50% 50%);
}
.envelope.open { animation-play-state:paused; opacity:0; }

@keyframes sway {0%{transform:rotateY(-5deg);}100%{transform:rotateY(5deg);}}

/* è¾“å…¥ç•Œé¢/ä¿¡çº¸ */
#inputPanel {
  display:none; flex-direction:column; align-items:center;
  width:50%; max-width:600px;
  position:relative; transition: all 0.5s ease;
}
#inputPanel::before {
  content:"";
  position:absolute; top:0; left:0; right:0; bottom:0;
  background: rgba(255,255,255,0.2);
  border-radius:24px;
  backdrop-filter: blur(12px);
  z-index:-1;
  background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
  background-repeat: repeat;
}
h1 {
  font-size:2.5rem; margin-bottom:2rem;
  background: linear-gradient(90deg,#5a7cff,#a0c4ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
#userInput {
  width:100%; padding:1rem;
  border-radius:16px; border:1px solid rgba(0,0,0,0.1);
  font-size:1.1rem; backdrop-filter: blur(8px);
  background: rgba(255,255,255,0.6); resize:none; margin-bottom:1rem;
}
#sendBtn {
  width:100%; padding:0.8rem;
  border:none; border-radius:16px; cursor:pointer;
  font-size:1.1rem;
  background: linear-gradient(90deg,#5a7cff,#a0c4ff);
  color:white; box-shadow:0 4px 12px rgba(0,0,0,0.1);
  transition:0.3s;
}
#sendBtn:hover { opacity:0.85; }

#loading { margin-top:0.5rem; color:#666; display:none; }

/* ä¿¡çº¸å›ä¿¡ç•Œé¢ */
#letterPanel {
  display:none; flex-direction:column; align-items:center;
  background: rgba(255,255,255,0.95);
  background-image: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.85)),
                    url('https://www.transparenttextures.com/patterns/paper-fibers.png');
  background-repeat:repeat;
  border-radius:24px; box-shadow:0 12px 36px rgba(0,0,0,0.2);
  padding:1rem; width:50%; max-width:600px; max-height:50%;
  overflow-y:auto; transform: scaleY(0); transform-origin:top;
  transition: transform 1s ease, opacity 0.8s ease;
}
#letterPanel.show { transform: scaleY(1); }

#letterText { width:100%; white-space:pre-wrap; font-size:1rem; color:#333; flex:1; margin-bottom:0.6rem; }

.letterControls { display:flex; justify-content:space-between; width:100%; gap:1rem; }
.letterControls button { flex:1; border:none; border-radius:16px; padding:0.6rem;
  backdrop-filter: blur(10px); background: rgba(255,255,255,0.6);
  box-shadow:0 4px 12px rgba(0,0,0,0.1); cursor:pointer; transition:0.3s; }
.letterControls button:hover { background: rgba(255,255,255,0.85); }

#bgPlus { display:none; font-size:3rem; color:#5a7cff; cursor:pointer; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }

#bgManager {
  display:none; position:absolute; top:10%; left:50%; transform:translateX(-50%);
  width:60%; max-width:600px; background: rgba(255,255,255,0.85);
  backdrop-filter: blur(12px); border-radius: 20px;
  box-shadow:0 12px 36px rgba(0,0,0,0.2); padding: 1rem; flex-direction: column; z-index:1000;
}
#bgHistory { display:flex; gap:0.5rem; overflow-x:auto; margin-top:0.5rem; }
.bgHistoryItem { width:50px; height:50px; border-radius:12px; border:1px solid #ccc; cursor:pointer; flex-shrink:0; background-size:cover; background-position:center; }
#bgManager button { margin-top:0.5rem; }

#voiceSelect { margin-bottom:0.5rem; width:100%; padding:0.6rem; border-radius:12px; border:1px solid #ccc; }

</style>
</head>
<body>

<div id="bgContainer"></div>

<div class="envelope-container">
  <div class="envelope" id="envelope">âœ‰ï¸</div>
</div>

<div id="inputPanel">
  <h1>æœªæ¥å›éŸ³</h1>
  <textarea id="userInput" placeholder="å†™ä¸‹æ­¤åˆ»çš„å¿ƒå£°ã€ç–‘æƒ‘æˆ–æ„¿æœ›..."></textarea>
  <select id="voiceSelect">
    <option value="male">ç”·å£°</option>
    <option value="female">å¥³å£°</option>
  </select>
  <button id="sendBtn">ç”Ÿæˆæœªæ¥å›ä¿¡</button>
  <div id="loading">æ­£åœ¨ç”Ÿæˆæœªæ¥çš„å›éŸ³...</div>
</div>

<div id="letterPanel">
  <div id="letterText"></div>
  <div class="letterControls">
    <button id="closeLetter">æ”¶èµ·å›ä¿¡</button>
    <button id="playVoice">è¯­éŸ³æ’­æ”¾</button>
  </div>
</div>

<script>
(function(){
const envelope = document.getElementById('envelope');
const inputPanel = document.getElementById('inputPanel');
const sendBtn = document.getElementById('sendBtn');
const userInput = document.getElementById('userInput');
const voiceSelect = document.getElementById('voiceSelect');
const loadingEl = document.getElementById('loading');
const letterPanel = document.getElementById('letterPanel');
const letterText = document.getElementById('letterText');
const closeLetter = document.getElementById('closeLetter');
const playVoice = document.getElementById('playVoice');

let isPlaying = false;
let audioObj = null;

// ä¿¡å°ç‚¹å‡»åŠ¨ç”»
envelope.addEventListener('click', ()=>{
  envelope.classList.add('open');
  setTimeout(()=>{
    envelope.parentElement.style.display='none';
    inputPanel.style.display='flex';
  },1000);
});

// ç”Ÿæˆæœªæ¥å›ä¿¡
sendBtn.addEventListener('click', async ()=>{
  const input = userInput.value.trim();
  if(!input){ alert('è¯·è¾“å…¥å†…å®¹'); return; }
  loadingEl.style.display='block';
  letterText.innerText='';
  try{
    const res = await fetch('/api/generate',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({input})
    });
    const data = await res.json();
    letterText.innerText = data.reply || 'æœªæ¥æš‚æ—¶æ²¡æ¥å¾—åŠå›å¤ã€‚';
    loadingEl.style.display='none';
    inputPanel.style.display='none';
    letterPanel.style.display='flex';
    setTimeout(()=>{ letterPanel.classList.add('show'); },50);
  }catch(err){
    loadingEl.style.display='none';
    letterText.innerText='ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯:'+err.message;
    inputPanel.style.display='none';
    letterPanel.style.display='flex';
    setTimeout(()=>{ letterPanel.classList.add('show'); },50);
  }
});

// æ”¶èµ·ä¿¡çº¸å›åˆ°è¾“å…¥ç•Œé¢
closeLetter.addEventListener('click', ()=>{
  letterPanel.classList.remove('show');
  stopVoice();
  setTimeout(()=>{ 
    letterPanel.style.display='none';
    inputPanel.style.display='flex';
  },800);
});

// è‡ªè¡Œç”Ÿæˆè¯­éŸ³ï¼ˆä¸ä¾èµ–æµè§ˆå™¨ TTSï¼‰
playVoice.addEventListener('click', async ()=>{
  if(isPlaying){
    stopVoice();
    return;
  }
  const text = letterText.innerText.trim();
  if(!text) return;
  const gender = voiceSelect.value;
  // å‡è®¾åç«¯ /api/voice æ¥å£è¿”å›ç”Ÿæˆå¥½çš„ mp3 æ–‡ä»¶ URL
  try{
    isPlaying=true;
    playVoice.innerText='åœæ­¢æ’­æ”¾';
    if(audioObj){ audioObj.pause(); audioObj=null; }
    audioObj=new Audio(`/api/voice?text=${encodeURIComponent(text)}&gender=${gender}`);
    audioObj.onended = ()=>{ stopVoice(); };
    audioObj.play();
  }catch(e){ stopVoice(); console.error(e);}
});

function stopVoice(){
  if(audioObj){ audioObj.pause(); audioObj=null; }
  isPlaying=false;
  playVoice.innerText='è¯­éŸ³æ’­æ”¾';
}

})();
</script>
</body>
</html>
