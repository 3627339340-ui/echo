<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æœªæ¥å›éŸ³ ğŸ’Œ</title>
<style>
  /* å…¨å±€æ ·å¼ */
  body {
    font-family:'PingFang SC','Segoe UI',sans-serif;
    background: linear-gradient(135deg,#f0f4ff,#fff9f2);
    margin:0;
    padding:0;
    height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    overflow:hidden;
    position:relative;
  }

  /* èƒŒæ™¯å¯æ›´æ¢å®¹å™¨ */
  #bgContainer {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    background-size:cover;
    background-position:center;
    z-index:-1;
    transition: background 0.5s ease;
    cursor:pointer;
  }

  #changeBgHint {
    position:absolute;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    font-size:0.9rem;
    color:#666;
    opacity:0;
    transition:opacity 0.3s;
    pointer-events:none;
  }

  /* ä¿¡å°æ ·å¼ */
  .envelope-container {
    perspective:1000px;
  }

  .envelope {
    width:280px; height:180px;
    background: rgba(255,255,255,0.85);
    border-radius:16px;
    border:1px solid rgba(255,255,255,0.5);
    box-shadow:0 8px 24px rgba(0,0,0,0.15);
    display:flex;
    justify-content:center;
    align-items:center;
    font-size:2rem;
    color:#5a7cff;
    cursor:pointer;
    transform-style: preserve-3d;
    animation: sway 2s ease-in-out infinite alternate;
  }

  .envelope.open { animation-play-state:paused; }

  @keyframes sway {
    0% { transform: rotateY(-5deg); }
    100% { transform: rotateY(5deg); }
  }

  /* æœªæ¥å›éŸ³é¢æ¿ */
  #letterPanel {
    width:320px;
    min-height:220px;
    padding:1rem;
    margin-top:1rem;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(12px);
    border-radius:16px;
    box-shadow:0 12px 36px rgba(0,0,0,0.15);
    display:none;
    flex-direction:column;
    transition: transform 0.5s ease, opacity 0.5s ease;
  }

  #letterText {
    flex:1;
    padding:0.5rem;
    font-size:1rem;
    color:#333;
    white-space:pre-wrap;
    overflow-y:auto;
    margin-bottom:0.8rem;
  }

  .controls {
    display:flex;
    gap:0.5rem;
    justify-content:flex-end;
  }

  .controls button {
    padding:0.5rem 1rem;
    border:none;
    border-radius:12px;
    font-size:0.9rem;
    cursor:pointer;
    backdrop-filter: blur(8px);
    background: rgba(255,255,255,0.6);
    box-shadow:0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
  }

  .controls button:hover { background: rgba(255,255,255,0.85); }

  /* è¾“å…¥æ¡†å’Œç”ŸæˆæŒ‰é’® */
  #userInput {
    width:100%;
    padding:0.8rem;
    border-radius:12px;
    border:1px solid rgba(0,0,0,0.15);
    margin-bottom:0.6rem;
    resize:none;
    font-size:1rem;
    backdrop-filter: blur(8px);
    background: rgba(255,255,255,0.6);
  }

  #sendBtn {
    width:100%;
    padding:0.8rem;
    border:none;
    border-radius:12px;
    background:#5a7cff;
    color:#fff;
    font-size:1rem;
    cursor:pointer;
    transition:0.3s;
  }

  #sendBtn:hover { background:#4668e8; }

  #loading {
    margin-top:0.5rem;
    color:#666;
    display:none;
  }

</style>
</head>
<body>
<div id="bgContainer"></div>
<div id="changeBgHint">ç‚¹å‡»èƒŒæ™¯æ›´æ¢èƒŒæ™¯</div>

<div class="envelope-container">
  <div class="envelope" id="envelope">ğŸ’Œ</div>
  <div id="letterPanel">
    <textarea id="userInput" placeholder="å†™ä¸‹æ­¤åˆ»çš„å¿ƒå£°ã€ç–‘æƒ‘æˆ–æ„¿æœ›..."></textarea>
    <button id="sendBtn">âœ¨ ç”Ÿæˆæœªæ¥å›ä¿¡</button>
    <div id="loading">ğŸ¤– æ­£åœ¨ç”Ÿæˆæœªæ¥çš„å›éŸ³...</div>
    <div id="letterText"></div>
    <div class="controls">
      <button id="closeLetter">æ”¶èµ·å›ä¿¡</button>
      <button id="playVoice">ğŸ”Š è¯­éŸ³æ’­æ”¾</button>
    </div>
  </div>
</div>

<script>
(function(){
  const envelope = document.getElementById('envelope');
  const letterPanel = document.getElementById('letterPanel');
  const sendBtn = document.getElementById('sendBtn');
  const userInput = document.getElementById('userInput');
  const loadingEl = document.getElementById('loading');
  const letterText = document.getElementById('letterText');
  const closeLetter = document.getElementById('closeLetter');
  const playVoice = document.getElementById('playVoice');
  const bgContainer = document.getElementById('bgContainer');
  const changeBgHint = document.getElementById('changeBgHint');

  let currentBgIndex = 0;
  const backgrounds = [
    'linear-gradient(135deg,#f0f4ff,#fff9f2)',
    'linear-gradient(135deg,#ffe6f0,#fff)',
    'linear-gradient(135deg,#e0fff9,#f0f8ff)',
  ];

  bgContainer.style.background = backgrounds[currentBgIndex];

  // ä¿¡å°ç‚¹å‡»
  envelope.addEventListener('click', ()=>{
    envelope.classList.add('open');
    letterPanel.style.display = 'flex';
  });

  // æ”¶èµ·å›ä¿¡
  closeLetter.addEventListener('click', ()=>{
    letterPanel.style.display = 'none';
    envelope.classList.remove('open');
  });

  // èƒŒæ™¯æ›´æ¢
  bgContainer.addEventListener('mouseenter', ()=>{ changeBgHint.style.opacity = 1; });
  bgContainer.addEventListener('mouseleave', ()=>{ changeBgHint.style.opacity = 0; });
  bgContainer.addEventListener('click', ()=>{
    currentBgIndex = (currentBgIndex + 1) % backgrounds.length;
    bgContainer.style.background = backgrounds[currentBgIndex];
  });

  // ç”Ÿæˆæœªæ¥å›ä¿¡
  sendBtn.addEventListener('click', async ()=>{
    const input = userInput.value.trim();
    if(!input){ alert('è¯·è¾“å…¥å†…å®¹'); return; }

    loadingEl.style.display = 'block';
    letterText.innerText = '';

    try{
      const res = await fetch('/api/generate',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({input})
      });

      loadingEl.style.display = 'none';

      if(!res.ok){
        letterText.innerText = 'è¯·æ±‚å¤±è´¥: ' + res.statusText;
        return;
      }

      const data = await res.json();
      if(data && data.reply){
        letterText.innerText = data.reply;
      }else{
        letterText.innerText = 'æœªæ¥æš‚æ—¶æ²¡æ¥å¾—åŠå›å¤ã€‚';
      }

    }catch(err){
      loadingEl.style.display = 'none';
      letterText.innerText = 'ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯: ' + err.message;
    }
  });

  // è¯­éŸ³æ’­æ”¾
  playVoice.addEventListener('click', ()=>{
    const text = letterText.innerText.trim();
    if(!text) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'zh-CN';
    speechSynthesis.speak(utter);
  });

})();
</script>
</body>
</html>
