<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æœªæ¥å›éŸ³ ğŸ’Œ</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="envelope" id="envelope"></div>
  <div class="title">æœªæ¥å›éŸ³ ğŸ’Œ</div>

  <div class="input-area" id="inputArea">
    <textarea id="message" placeholder="å†™ä¸‹æ­¤åˆ»å¿ƒå£°..."></textarea>
    <div>
      <label><input type="radio" name="voice" value="female" checked> å¥³å£°</label>
      <label><input type="radio" name="voice" value="male"> ç”·å£°</label>
    </div>
    <button id="generate">ç”Ÿæˆæœªæ¥å›ä¿¡</button>
  </div>

  <div class="letter" id="letter"></div>
  <div class="controls" id="controls" style="display:none;">
    <button id="voiceBtn">ğŸ”Š æ’­æ”¾è¯­éŸ³</button>
  </div>

  <script>
    const envelope = document.getElementById("envelope");
    const inputArea = document.getElementById("inputArea");
    const letter = document.getElementById("letter");
    const controls = document.getElementById("controls");
    const voiceBtn = document.getElementById("voiceBtn");
    const generateBtn = document.getElementById("generate");
    const body = document.body;

    const gradients = [
      ["#ffb0d9", "#d6b0ff"],
      ["#ffc7a4", "#ff8db0"],
      ["#a4c8ff", "#c6a4ff"],
      ["#ffa8b0", "#ffb0f0"]
    ];

    setTimeout(() => showInput(), 3000);

    envelope.addEventListener("click", showInput);

    function showInput() {
      envelope.style.display = "none";
      inputArea.style.display = "flex";
    }

    generateBtn.addEventListener("click", async () => {
      const text = document.getElementById("message").value;
      const gender = document.querySelector('input[name="voice"]:checked').value;

      letter.style.display = "flex";
      letter.innerText = "æœªæ¥çš„ä½ è¯´ï¼š\n\n" + text;
      controls.style.display = "flex";

      const res = await fetch("/api/voice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, gender })
      });

      const data = await res.json();
      if (data.url) {
        let audio = new Audio(data.url);
        let playing = false;

        voiceBtn.onclick = () => {
          if (!playing) {
            audio.play();
            playing = true;
            voiceBtn.textContent = "â¹ åœæ­¢æ’­æ”¾";
          } else {
            audio.pause();
            audio.currentTime = 0;
            playing = false;
            voiceBtn.textContent = "ğŸ”Š æ’­æ”¾è¯­éŸ³";
          }
        };
      }
    });

    body.addEventListener("click", () => {
      const g = gradients[Math.floor(Math.random() * gradients.length)];
      body.style.background = `radial-gradient(circle at center, ${g[0]}, ${g[1]}, #000)`;
    });
  </script>
</body>
</html>  position:absolute;
  top:33%;
  text-align:center;
  width:100%;
  font-size:48px;
  color:white;
  font-weight:600;
  letter-spacing:3px;
  text-shadow:0 0 10px rgba(255,255,255,0.3);
}
#inputPanel, #letterPanel{
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  text-align:center;
  width:100%;
  height:100%;
}
#userInput{
  width:70%;
  height:120px;
  border:none;
  outline:none;
  resize:none;
  border-radius:20px;
  padding:20px;
  font-size:18px;
  background:rgba(255,255,255,0.2);
  color:#fff;
  backdrop-filter:blur(10px);
  box-shadow:0 0 15px rgba(255,255,255,0.1);
}
#sendBtn{
  margin-top:25px;
  padding:12px 36px;
  border:none;
  border-radius:25px;
  background:linear-gradient(135deg,#ffb6c1,#add8e6);
  color:#fff;
  font-size:18px;
  font-weight:500;
  cursor:pointer;
  transition:transform .2s,opacity .3s;
  backdrop-filter:blur(12px);
  box-shadow:0 0 20px rgba(255,255,255,0.2);
}
#sendBtn:hover{transform:scale(1.05);opacity:0.9;}

#loading{
  display:none;
  color:#fff;
  font-size:18px;
  margin-top:15px;
}

#letterPanel.show{
  opacity:1;transition:opacity 1s;
}
#letterPanel{
  opacity:0;
  transition:opacity 1s;
}
#letterText{
  width:70%;
  min-height:250px;
  color:#fff;
  font-size:20px;
  background:rgba(255,255,255,0.15);
  padding:20px;
  border-radius:20px;
  backdrop-filter:blur(8px);
  box-shadow:0 0 10px rgba(255,255,255,0.15);
}
.controls{
  margin-top:25px;
  display:flex;
  gap:20px;
  justify-content:center;
}
.btn{
  padding:10px 28px;
  border:none;
  border-radius:25px;
  background:linear-gradient(135deg,#ffb6c1,#add8e6);
  color:#fff;
  font-size:16px;
  font-weight:500;
  cursor:pointer;
  backdrop-filter:blur(8px);
  transition:opacity .3s;
}
.btn:hover{opacity:0.85;}
#voiceSelect{
  margin-top:20px;
  padding:8px 14px;
  border-radius:15px;
  border:none;
  background:rgba(255,255,255,0.3);
  color:#fff;
  backdrop-filter:blur(10px);
}
</style>
</head>
<body>
<div id="bgContainer"></div>
<div id="title">æœªæ¥å›éŸ³</div>
<div id="envelope">ğŸ’Œ</div>

<div id="inputPanel">
  <textarea id="userInput" placeholder="å†™ä¸‹æ­¤åˆ»çš„å¿ƒå£°å§..."></textarea>
  <select id="voiceSelect">
    <option value="female">å¥³å£°</option>
    <option value="male">ç”·å£°</option>
  </select>
  <button id="sendBtn">ç”Ÿæˆæœªæ¥å›éŸ³</button>
  <div id="loading">ç”Ÿæˆä¸­...</div>
</div>

<div id="letterPanel">
  <div id="letterText"></div>
  <div class="controls">
    <button class="btn" id="closeLetter">æ”¶èµ·å›ä¿¡</button>
    <button class="btn" id="playVoice">è¯­éŸ³æ’­æ”¾</button>
  </div>
</div>

<script>
(function(){
const envelope = document.getElementById('envelope');
const inputPanel = document.getElementById('inputPanel');
const letterPanel = document.getElementById('letterPanel');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const letterText = document.getElementById('letterText');
const closeLetter = document.getElementById('closeLetter');
const playVoice = document.getElementById('playVoice');
const voiceSelect = document.getElementById('voiceSelect');
const loadingEl = document.getElementById('loading');
const bgContainer = document.getElementById('bgContainer');
let isPlaying=false; let audioObj=null;

// ç‚¹å‡»ä¿¡å°å±•å¼€
function showInputPanel(){
  envelope.style.opacity='0';
  setTimeout(()=>{
    envelope.style.display='none';
    inputPanel.style.display='flex';
  },1000);
}

// ç‚¹å‡»ä¿¡å°
envelope.addEventListener('click', showInputPanel);

// 3 ç§’åè‡ªåŠ¨å±•å¼€
setTimeout(()=>{
  if(inputPanel.style.display!=='flex'){
    showInputPanel();
  }
},3000);

// èƒŒæ™¯æ¸å˜åˆ‡æ¢
const gradients=[
  'radial-gradient(circle at center, #ffb6c1 0%, #4b004b 100%)',
  'radial-gradient(circle at center, #ffa07a 0%, #330000 100%)',
  'radial-gradient(circle at center, #b0e0e6 0%, #191970 100%)',
  'radial-gradient(circle at center, #ffcccb 0%, #800000 100%)',
  'radial-gradient(circle at center, #add8e6 0%, #00008b 100%)'
];
bgContainer.addEventListener('click',()=>{
  const g=gradients[Math.floor(Math.random()*gradients.length)];
  document.body.style.background=g;
  bgContainer.style.background=g;
});

// ç”Ÿæˆæœªæ¥å›ä¿¡
sendBtn.addEventListener('click', async()=>{
  const input=userInput.value.trim();
  if(!input) return alert('è¯·è¾“å…¥å†…å®¹');
  loadingEl.style.display='block';
  try{
    const res=await fetch('/api/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({input})});
    const data=await res.json();
    letterText.innerText=data.reply || 'æœªæ¥æš‚æ—¶è¿˜æ²¡æ¥å¾—åŠå›å¤ã€‚';
  }catch(e){
    letterText.innerText='å‡ºé”™äº†ï¼š'+e.message;
  }
  loadingEl.style.display='none';
  inputPanel.style.display='none';
  letterPanel.style.display='flex';
  setTimeout(()=>{letterPanel.classList.add('show');},50);
});

// æ”¶èµ·å›ä¿¡
closeLetter.addEventListener('click',()=>{
  letterPanel.classList.remove('show');
  stopVoice();
  setTimeout(()=>{
    letterPanel.style.display='none';
    inputPanel.style.display='flex';
  },800);
});

// è¯­éŸ³æ’­æ”¾
playVoice.addEventListener('click',()=>{
  if(isPlaying){stopVoice();return;}
  const text=letterText.innerText;
  const gender=voiceSelect.value;
  audioObj=new Audio(`/api/voice?text=${encodeURIComponent(text)}&gender=${gender}`);
  audioObj.play();
  isPlaying=true;
  playVoice.innerText='åœæ­¢æ’­æ”¾';
  audioObj.onended=()=>stopVoice();
});
function stopVoice(){
  if(audioObj){audioObj.pause();audioObj=null;}
  isPlaying=false;
  playVoice.innerText='è¯­éŸ³æ’­æ”¾';
}
})();
</script>
</body>
</html>
